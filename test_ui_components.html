<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Tracking UI Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        .mock-progress {
            padding: 20px;
            border: 2px solid #007bff;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ UI Progress Tracking Component Test</h1>
        <p>This test simulates the Cat and Mouse Game progress tracking scenario to identify UI issues.</p>
        
        <div class="test-section">
            <h2>üìã Test Scenario</h2>
            <div class="info test-result">
                <strong>Idea:</strong> Cat and Mouse Game<br>
                <strong>Description:</strong> Game for 4-10 year olds to learn strategy<br>
                <strong>Approach:</strong> Market Deep-Dive<br>
                <strong>Issue:</strong> "Failed to track progress" error in UI
            </div>
        </div>

        <div class="test-section">
            <h2>üîß API Connectivity Test</h2>
            <button onclick="testBackendConnection()">Test Backend Connection</button>
            <button onclick="testAuthEndpoint()">Test Authentication</button>
            <button onclick="testProgressEndpoint()">Test Progress Endpoint</button>
            <div id="api-results" class="test-result info" style="display: none;">
                <div id="api-status"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üìä Mock Progress Tracking</h2>
            <button onclick="startMockProgress()">Start Mock Analysis</button>
            <button onclick="simulateError()">Simulate Progress Error</button>
            <button onclick="resetMockProgress()">Reset</button>
            
            <div id="mock-progress" class="mock-progress" style="display: none;">
                <h3 id="analysis-title">Market Deep-Dive Analysis</h3>
                <h4 id="idea-title">Cat and Mouse Game</h4>
                
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div id="progress-text">0% complete</div>
                
                <div id="current-phase" style="margin-top: 15px;">
                    <strong>Current Phase:</strong> <span id="phase-name">Initializing...</span>
                </div>
                
                <div id="current-step" style="margin-top: 10px;">
                    <strong>Current Step:</strong> <span id="step-name">Preparing analysis</span>
                </div>
                
                <div id="messages" style="margin-top: 15px;">
                    <strong>Recent Activity:</strong>
                    <ul id="message-list"></ul>
                </div>
                
                <div id="error-display" style="display: none;" class="error test-result">
                    <strong>‚ùå Analysis Error</strong><br>
                    <span id="error-message">Failed to track progress</span><br>
                    <button onclick="resetMockProgress()" style="margin-top: 10px;">Try Again</button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>üß¨ Component Interface Test</h2>
            <button onclick="testComponentInterface()">Test React Component Props</button>
            <div id="interface-results" class="test-result info" style="display: none;">
                <div id="interface-status"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üìù Test Results Summary</h2>
            <div id="test-summary" class="test-result warning">
                Click the test buttons above to run diagnostics
            </div>
        </div>
    </div>

    <script type="text/babel">
        let mockProgressInterval;
        let testResults = [];

        // Test backend connection
        async function testBackendConnection() {
            const resultsDiv = document.getElementById('api-results');
            const statusDiv = document.getElementById('api-status');
            resultsDiv.style.display = 'block';
            
            const endpoints = [
                'http://localhost:8000/health',
                'http://127.0.0.1:8000/health',
                'http://localhost:4000/api/v1/research-strategy/approaches'
            ];
            
            let results = '<strong>Backend Connection Test:</strong><br>';
            let anySuccess = false;
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint, { 
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        results += `‚úÖ ${endpoint} - Connected<br>`;
                        anySuccess = true;
                    } else {
                        results += `‚ùå ${endpoint} - Status ${response.status}<br>`;
                    }
                } catch (error) {
                    results += `‚ùå ${endpoint} - ${error.message}<br>`;
                }
            }
            
            statusDiv.innerHTML = results;
            resultsDiv.className = anySuccess ? 'test-result success' : 'test-result error';
            testResults.push({ test: 'Backend Connection', success: anySuccess });
            updateSummary();
        }

        // Test authentication endpoint
        async function testAuthEndpoint() {
            const resultsDiv = document.getElementById('api-results');
            const statusDiv = document.getElementById('api-status');
            resultsDiv.style.display = 'block';
            
            try {
                const response = await axios.post('/api/v1/auth/bypass', {
                    role: 'user'
                });
                
                if (response.data && response.data.access_token) {
                    statusDiv.innerHTML = '<strong>‚úÖ Authentication Test Passed</strong><br>Successfully obtained access token via bypass login';
                    resultsDiv.className = 'test-result success';
                    testResults.push({ test: 'Authentication', success: true, token: response.data.access_token });
                } else {
                    statusDiv.innerHTML = '<strong>‚ùå Authentication Test Failed</strong><br>No access token in response';
                    resultsDiv.className = 'test-result error';
                    testResults.push({ test: 'Authentication', success: false });
                }
            } catch (error) {
                statusDiv.innerHTML = `<strong>‚ùå Authentication Test Failed</strong><br>Error: ${error.message}`;
                resultsDiv.className = 'test-result error';
                testResults.push({ test: 'Authentication', success: false, error: error.message });
            }
            
            updateSummary();
        }

        // Test progress endpoint with mock data
        async function testProgressEndpoint() {
            const resultsDiv = document.getElementById('api-results');
            const statusDiv = document.getElementById('api-status');
            resultsDiv.style.display = 'block';
            
            // First get auth token
            const authResult = testResults.find(r => r.test === 'Authentication' && r.success);
            if (!authResult) {
                statusDiv.innerHTML = '<strong>‚ö†Ô∏è Progress Test Skipped</strong><br>Authentication required first';
                resultsDiv.className = 'test-result warning';
                return;
            }
            
            try {
                // Set auth header
                axios.defaults.headers.common['Authorization'] = `Bearer ${authResult.token}`;
                
                // Try to create a test strategy
                const strategyResponse = await axios.post('/api/v1/research-strategy/initiate', {
                    session_id: 1,
                    approach: 'market_deep_dive',
                    custom_parameters: {
                        idea_title: 'Cat and Mouse Game',
                        idea_description: 'Game for 4-10 year olds to learn strategy'
                    }
                });
                
                const strategyId = strategyResponse.data.strategy.id;
                
                // Execute the strategy
                await axios.post(`/api/v1/research-strategy/execute/${strategyId}`);
                
                // Test progress endpoint
                const progressResponse = await axios.get(`/api/v1/research-strategy/progress/${strategyId}`);
                
                if (progressResponse.data && 'progress_percentage' in progressResponse.data) {
                    statusDiv.innerHTML = `<strong>‚úÖ Progress Endpoint Test Passed</strong><br>Strategy ID: ${strategyId}<br>Progress: ${progressResponse.data.progress_percentage}%<br>Phase: ${progressResponse.data.current_phase}`;
                    resultsDiv.className = 'test-result success';
                    testResults.push({ test: 'Progress Endpoint', success: true, strategyId });
                } else {
                    statusDiv.innerHTML = '<strong>‚ùå Progress Endpoint Test Failed</strong><br>Invalid progress data structure';
                    resultsDiv.className = 'test-result error';
                    testResults.push({ test: 'Progress Endpoint', success: false });
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<strong>‚ùå Progress Endpoint Test Failed</strong><br>Error: ${error.response?.data?.detail || error.message}`;
                resultsDiv.className = 'test-result error';
                testResults.push({ test: 'Progress Endpoint', success: false, error: error.message });
            }
            
            updateSummary();
        }

        // Start mock progress simulation
        function startMockProgress() {
            const mockDiv = document.getElementById('mock-progress');
            const errorDiv = document.getElementById('error-display');
            mockDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            
            const phases = [
                { name: 'Market Context Analysis', steps: ['Gathering market data', 'Analyzing industry trends', 'Assessing market size'] },
                { name: 'Competitive Intelligence', steps: ['Identifying competitors', 'Analyzing positioning', 'Finding market gaps'] },
                { name: 'Strategic Assessment', steps: ['Conducting SWOT analysis', 'Evaluating opportunities', 'Generating recommendations'] }
            ];
            
            let currentPhase = 0;
            let currentStep = 0;
            let progress = 0;
            
            mockProgressInterval = setInterval(() => {
                if (progress >= 100) {
                    clearInterval(mockProgressInterval);
                    document.getElementById('progress-text').textContent = '100% complete - Analysis finished!';
                    document.getElementById('phase-name').textContent = 'Completed';
                    document.getElementById('step-name').textContent = 'Analysis complete';
                    return;
                }
                
                progress += Math.random() * 15;
                progress = Math.min(progress, 100);
                
                // Update progress bar
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('progress-text').textContent = Math.round(progress) + '% complete';
                
                // Update phase and step
                const phaseIndex = Math.floor((progress / 100) * phases.length);
                if (phaseIndex < phases.length) {
                    const phase = phases[phaseIndex];
                    document.getElementById('phase-name').textContent = phase.name;
                    
                    const stepIndex = Math.floor((progress % (100/phases.length)) / (100/phases.length) * phase.steps.length);
                    if (stepIndex < phase.steps.length) {
                        document.getElementById('step-name').textContent = phase.steps[stepIndex];
                        
                        // Add message
                        const messageList = document.getElementById('message-list');
                        const li = document.createElement('li');
                        li.textContent = phase.steps[stepIndex];
                        messageList.appendChild(li);
                        
                        // Keep only last 3 messages
                        while (messageList.children.length > 3) {
                            messageList.removeChild(messageList.firstChild);
                        }
                    }
                }
            }, 1000);
            
            testResults.push({ test: 'Mock Progress', success: true });
            updateSummary();
        }

        // Simulate the "Failed to track progress" error
        function simulateError() {
            const mockDiv = document.getElementById('mock-progress');
            const errorDiv = document.getElementById('error-display');
            
            if (mockProgressInterval) {
                clearInterval(mockProgressInterval);
            }
            
            mockDiv.style.display = 'block';
            errorDiv.style.display = 'block';
            
            // Set some initial progress
            document.getElementById('progress-fill').style.width = '25%';
            document.getElementById('progress-text').textContent = '25% complete';
            document.getElementById('phase-name').textContent = 'Market Context Analysis';
            document.getElementById('step-name').textContent = 'Analyzing market size';
            
            testResults.push({ test: 'Error Simulation', success: true });
            updateSummary();
        }

        // Reset mock progress
        function resetMockProgress() {
            if (mockProgressInterval) {
                clearInterval(mockProgressInterval);
            }
            
            const mockDiv = document.getElementById('mock-progress');
            const errorDiv = document.getElementById('error-display');
            
            mockDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-text').textContent = '0% complete';
            document.getElementById('phase-name').textContent = 'Initializing...';
            document.getElementById('step-name').textContent = 'Preparing analysis';
            document.getElementById('message-list').innerHTML = '';
        }

        // Test React component interface
        function testComponentInterface() {
            const resultsDiv = document.getElementById('interface-results');
            const statusDiv = document.getElementById('interface-status');
            resultsDiv.style.display = 'block';
            
            let results = '<strong>Component Interface Test:</strong><br>';
            let allTestsPassed = true;
            
            // Test required props structure
            const requiredProps = {
                strategyId: 12345,
                approach: {
                    approach: 'market_deep_dive',
                    title: 'Market Deep-Dive',
                    description: 'Comprehensive market analysis'
                },
                ideaTitle: 'Cat and Mouse Game',
                ideaDescription: 'Game for 4-10 year olds',
                onComplete: function() {},
                autoStart: true
            };
            
            // Check if props have correct structure
            try {
                if (typeof requiredProps.strategyId === 'number') {
                    results += '‚úÖ strategyId prop type correct<br>';
                } else {
                    results += '‚ùå strategyId prop type incorrect<br>';
                    allTestsPassed = false;
                }
                
                if (requiredProps.approach && typeof requiredProps.approach.approach === 'string') {
                    results += '‚úÖ approach prop structure correct<br>';
                } else {
                    results += '‚ùå approach prop structure incorrect<br>';
                    allTestsPassed = false;
                }
                
                if (typeof requiredProps.onComplete === 'function') {
                    results += '‚úÖ onComplete callback provided<br>';
                } else {
                    results += '‚ùå onComplete callback missing<br>';
                    allTestsPassed = false;
                }
                
                results += '<br><strong>Expected props structure:</strong><br>';
                results += '<pre>' + JSON.stringify(requiredProps, null, 2) + '</pre>';
                
            } catch (error) {
                results += `‚ùå Interface test error: ${error.message}<br>`;
                allTestsPassed = false;
            }
            
            statusDiv.innerHTML = results;
            resultsDiv.className = allTestsPassed ? 'test-result success' : 'test-result error';
            testResults.push({ test: 'Component Interface', success: allTestsPassed });
            updateSummary();
        }

        // Update test summary
        function updateSummary() {
            const summaryDiv = document.getElementById('test-summary');
            
            if (testResults.length === 0) {
                summaryDiv.innerHTML = 'Click the test buttons above to run diagnostics';
                summaryDiv.className = 'test-result warning';
                return;
            }
            
            const passed = testResults.filter(r => r.success).length;
            const total = testResults.length;
            
            let summary = `<strong>Test Results: ${passed}/${total} tests passed</strong><br><br>`;
            
            testResults.forEach(result => {
                const icon = result.success ? '‚úÖ' : '‚ùå';
                summary += `${icon} ${result.test}<br>`;
            });
            
            if (passed === total) {
                summary += '<br><strong>üéâ All tests passed! UI components should work correctly.</strong>';
                summaryDiv.className = 'test-result success';
            } else {
                summary += '<br><strong>‚ö†Ô∏è Some tests failed. Check the issues above.</strong>';
                summaryDiv.className = 'test-result error';
            }
            
            // Add specific recommendations
            summary += '<br><br><strong>Recommendations:</strong><br>';
            
            if (!testResults.find(r => r.test === 'Backend Connection' && r.success)) {
                summary += '‚Ä¢ Start the backend server: <code>cd backend && python main.py</code><br>';
            }
            
            if (!testResults.find(r => r.test === 'Authentication' && r.success)) {
                summary += '‚Ä¢ Check authentication configuration and bypass login setup<br>';
            }
            
            if (testResults.find(r => r.test === 'Progress Endpoint' && !r.success)) {
                summary += '‚Ä¢ The "Failed to track progress" error is likely in the backend API<br>';
                summary += '‚Ä¢ Check backend logs for detailed error messages<br>';
            }
            
            summaryDiv.innerHTML = summary;
        }

        // Set up axios defaults
        axios.defaults.baseURL = '/api/v1';
        axios.defaults.timeout = 10000;
    </script>
</body>
</html>