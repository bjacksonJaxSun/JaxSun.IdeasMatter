<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Testing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
        }
        .success {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .info {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #2563eb;
        }
        button.admin {
            background-color: #7c3aed;
        }
        button.admin:hover {
            background-color: #6d28d9;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Authentication Testing</h1>
        <p>This page tests the authentication system independently of the main application.</p>
        
        <div class="test-section info">
            <h2>üìä System Status</h2>
            <div id="systemStatus">Checking...</div>
            <button onclick="checkSystemStatus()">Refresh Status</button>
        </div>
        
        <div class="test-section">
            <h2>üîê Mock Authentication Test</h2>
            <p>Test the mock authentication system (works offline):</p>
            <button onclick="testMockAuth('user')">Login as User (Mock)</button>
            <button onclick="testMockAuth('admin')" class="admin">Login as Admin (Mock)</button>
            <button onclick="clearAuth()">Clear Auth</button>
            <div id="mockAuthResult"></div>
        </div>
        
        <div class="test-section">
            <h2>üåê API Authentication Test</h2>
            <p>Test the backend API authentication:</p>
            <button onclick="testApiAuth('user')">Login as User (API)</button>
            <button onclick="testApiAuth('admin')" class="admin">Login as Admin (API)</button>
            <div id="apiAuthResult"></div>
        </div>
        
        <div class="test-section">
            <h2>üìã Current Authentication State</h2>
            <button onclick="showCurrentAuth()">Show Current Auth</button>
            <div id="currentAuthState"></div>
        </div>
        
        <div class="test-section">
            <h2>üìù Test Log</h2>
            <button onclick="clearLog()">Clear Log</button>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <script>
        // Mock Authentication Implementation
        class MockAuth {
            static createMockUser(role) {
                const users = {
                    user: {
                        id: 2,
                        email: 'user@example.com',
                        name: 'Test User',
                        role: 'user',
                        permissions: ['read', 'write'],
                        tenantId: 'mock-tenant-001'
                    },
                    admin: {
                        id: 1,
                        email: 'admin@example.com',
                        name: 'Admin User',
                        role: 'admin',
                        permissions: ['read', 'write', 'delete', 'admin'],
                        tenantId: 'mock-tenant-001'
                    }
                };
                return users[role] || users.user;
            }
            
            static generateMockTokens(role) {
                const timestamp = Date.now();
                const randomSuffix = Math.random().toString(36).substring(7);
                return {
                    accessToken: `mock_${role}_token_${timestamp}_${randomSuffix}`,
                    refreshToken: `mock_refresh_${role}_token_${timestamp}_${randomSuffix}`
                };
            }
            
            static storeMockAuth(role) {
                const user = this.createMockUser(role);
                const tokens = this.generateMockTokens(role);
                
                localStorage.setItem('access_token', tokens.accessToken);
                localStorage.setItem('refresh_token', tokens.refreshToken);
                localStorage.setItem('mock_auth', 'true');
                localStorage.setItem('mock_user', JSON.stringify(user));
                
                return user;
            }
            
            static isMockAuth() {
                const isMock = localStorage.getItem('mock_auth') === 'true';
                const token = localStorage.getItem('access_token');
                return isMock && token && token.startsWith('mock_');
            }
            
            static getMockUser() {
                if (!this.isMockAuth()) return null;
                
                const storedUser = localStorage.getItem('mock_user');
                if (storedUser) {
                    try {
                        return JSON.parse(storedUser);
                    } catch (e) {
                        console.warn('Failed to parse stored mock user');
                    }
                }
                return null;
            }
            
            static clearAuth() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('mock_auth');
                localStorage.removeItem('mock_user');
            }
        }
        
        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const logEntry = `[${timestamp}] ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        // Clear log
        function clearLog() {
            document.getElementById('testLog').textContent = '';
        }
        
        // Test mock authentication
        async function testMockAuth(role) {
            log(`üîß Testing mock authentication for role: ${role}`);
            
            try {
                // Simulate delay
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const user = MockAuth.storeMockAuth(role);
                
                document.getElementById('mockAuthResult').innerHTML = `
                    <div class="status success">
                        ‚úÖ Mock authentication successful!<br>
                        User: ${user.name} (${user.email})<br>
                        Role: ${user.role}<br>
                        Permissions: ${user.permissions.join(', ')}
                    </div>
                `;
                
                log(`‚úÖ Mock auth successful: ${user.email} as ${user.role}`);
                
                // Show redirect simulation
                setTimeout(() => {
                    log(`üîÑ Would redirect to /${role === 'admin' ? 'admin' : 'dashboard'}`);
                }, 1000);
                
            } catch (error) {
                document.getElementById('mockAuthResult').innerHTML = `
                    <div class="status error">
                        ‚ùå Mock authentication failed: ${error.message}
                    </div>
                `;
                log(`‚ùå Mock auth failed: ${error.message}`);
            }
        }
        
        // Test API authentication
        async function testApiAuth(role) {
            log(`üåê Testing API authentication for role: ${role}`);
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/auth/bypass', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Store tokens
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token);
                    localStorage.removeItem('mock_auth');
                    
                    document.getElementById('apiAuthResult').innerHTML = `
                        <div class="status success">
                            ‚úÖ API authentication successful!<br>
                            Token: ${data.access_token.substring(0, 20)}...<br>
                            Type: ${data.token_type}
                        </div>
                    `;
                    
                    log(`‚úÖ API auth successful: token received`);
                    
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                document.getElementById('apiAuthResult').innerHTML = `
                    <div class="status error">
                        ‚ùå API authentication failed: ${error.message}<br>
                        <small>This is expected if backend is not running</small>
                    </div>
                `;
                log(`‚ùå API auth failed: ${error.message}`);
                
                // Fallback to mock auth
                log(`üîß Falling back to mock authentication...`);
                await testMockAuth(role);
            }
        }
        
        // Show current authentication state
        function showCurrentAuth() {
            const token = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');
            const isMock = MockAuth.isMockAuth();
            const mockUser = MockAuth.getMockUser();
            
            let authInfo = '';
            
            if (token) {
                authInfo += `Access Token: ${token.substring(0, 30)}...<br>`;
                authInfo += `Refresh Token: ${refreshToken ? refreshToken.substring(0, 30) + '...' : 'None'}<br>`;
                authInfo += `Auth Type: ${isMock ? 'Mock' : 'API'}<br>`;
                
                if (mockUser) {
                    authInfo += `User: ${mockUser.name} (${mockUser.email})<br>`;
                    authInfo += `Role: ${mockUser.role}<br>`;
                    authInfo += `Permissions: ${mockUser.permissions.join(', ')}<br>`;
                }
                
                document.getElementById('currentAuthState').innerHTML = `
                    <div class="status success">
                        üîê Authenticated<br>
                        ${authInfo}
                    </div>
                `;
            } else {
                document.getElementById('currentAuthState').innerHTML = `
                    <div class="status error">
                        üö´ Not authenticated
                    </div>
                `;
            }
            
            log(`üìä Current auth state: ${token ? 'Authenticated' : 'Not authenticated'}`);
        }
        
        // Clear authentication
        function clearAuth() {
            MockAuth.clearAuth();
            document.getElementById('mockAuthResult').innerHTML = '';
            document.getElementById('apiAuthResult').innerHTML = '';
            document.getElementById('currentAuthState').innerHTML = '';
            log(`üßπ Authentication cleared`);
        }
        
        // Check system status
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = 'Checking...';
            
            let backendStatus = '‚ùå Offline';
            let frontendStatus = '‚ùå Offline';
            
            // Check backend
            try {
                const response = await fetch('http://localhost:8000/', { timeout: 3000 });
                if (response.ok) {
                    backendStatus = '‚úÖ Online';
                }
            } catch (e) {
                backendStatus = '‚ùå Offline';
            }
            
            // Check frontend (current page is running, so it's online)
            frontendStatus = '‚úÖ Online (this page)';
            
            statusDiv.innerHTML = `
                Backend (port 8000): ${backendStatus}<br>
                Frontend (port 4000): ${frontendStatus}<br>
                LocalStorage: ‚úÖ Available<br>
                Mock Auth: ${MockAuth.isMockAuth() ? '‚úÖ Active' : '‚≠ï Inactive'}
            `;
            
            log(`üìä System status checked`);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Authentication test page loaded');
            checkSystemStatus();
            showCurrentAuth();
        });
    </script>
</body>
</html>